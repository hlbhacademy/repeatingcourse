<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>113-2 國立花蓮高商重補修課程查詢日曆</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
body{font-family:'Noto Sans TC','Microsoft JhengHei',Arial,sans-serif;margin:1em}
h2{text-align:center;margin-bottom:.5em}
#filter-bar{display:flex;justify-content:center;align-items:center;margin-bottom:1em;font-size:1.4em}
#courseSelect{margin-left:.5em;padding:.4em 1em;font-size:1.1em}
#calendar{max-width:1100px;margin:auto}
.fc-daygrid-event-dot{display:none}
.fc-daygrid-event .fc-event-title,.fc-timegrid-event .fc-event-title{white-space:pre-line!important;font-weight:bold;font-size:1.06em;word-break:break-all}
.fc-timegrid-event,.fc-timegrid-event .fc-event-title{color:#222!important;min-height:50px!important;height:auto!important;white-space:pre-line!important;overflow:visible!important}
.course-icon{font-size:1.3em;margin-right:2px;vertical-align:middle}
.highlight-red{color:#C00000!important;font-weight:bold}
.disabled-row{background:#888!important;color:#fff!important}
.disabled-row td{background:#888!important;color:#fff!important}
#list-container{max-width:1100px;margin:2em auto}
#list-container table{border-collapse:collapse;width:100%}
#list-container th,#list-container td{border:1px solid #aaa;padding:.5em;text-align:center;font-size:1.08em}
#list-container th{background:#f4f4f4;font-size:1.13em}
@media(max-width:800px){
  #calendar,#list-container{width:100%;font-size:.96em}
  #filter-bar{font-size:1.1em}
}
</style>
</head>
<body>
<h2>📅 113-2 國立花蓮高商重補修課程查詢日曆</h2>

<div id="filter-bar">
  <label for="courseSelect">篩選課程：</label>
  <select id="courseSelect"><option value="">全部</option></select>
</div>

<div id="calendar"></div>

<div id="list-container">
  <h3>課程列表（含跨月顯示，依日期排序）</h3>
  <div id="list-content"></div>
</div>

<script>
const apiUrl="https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

/* ---------- 通用工具 ---------- */
const fixDate=d=>{
  if(!d)return"";
  d=d.toString().trim().replace(/\//g,"-");
  const m=d.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  return m?`${m[1]}-${m[2].padStart(2,"0")}-${m[3].padStart(2,"0")}`:"";
};

const fixTime=t=>{
  if(!t)return"00:00";
  t=t.toString().replace(/\s+/g,"");
  // 中文上午/下午
  let m=t.match(/^(上午|下午)(\d{1,2}):(\d{2})/);
  if(m){
    let h=parseInt(m[2],10);
    if(m[1]==="下午"&&h!==12)h+=12;
    if(m[1]==="上午"&&h===12)h=0;
    return `${h.toString().padStart(2,"0")}:${m[3]}`;
  }
  // AM / PM
  m=t.match(/^(\d{1,2}):(\d{2})(AM|PM)$/i);
  if(m){
    let h=parseInt(m[1],10);
    if(m[3].toUpperCase()==="PM"&&h!==12)h+=12;
    if(m[3].toUpperCase()==="AM"&&h===12)h=0;
    return `${h.toString().padStart(2,"0")}:${m[2]}`;
  }
  // 純 24hr
  m=t.match(/^(\d{1,2}):(\d{2})/);
  return m?`${m[1].padStart(2,"0")}:${m[2]}`:"00:00";
};

const getCourseLabel=it=>it["課程名稱"].replace(/\s+/g," ").trim();

/* ---------- 把異動前紀錄去掉，只留異動後 ---------- */
function mergeRows(rows){
  const map=new Map(); // key = 課程+教師+原日期
  rows.forEach(r=>{
    const oriKey=[getCourseLabel(r),r["教師"]||"",fixDate(r["日期"])].join("|");
    if(r["異動日期"]){          // 有異動 → 用異動後的資料覆蓋
      const newKey=[getCourseLabel(r),r["教師"]||"",fixDate(r["異動日期"])].join("|");
      map.set(newKey,{...r,__displayDate:fixDate(r["異動日期"]),__isModified:true});
    }else if(!map.has(oriKey)){ // 沒異動 → 如尚未被覆蓋才放入
      map.set(oriKey,{...r,__displayDate:fixDate(r["日期"]),__isModified:false});
    }
  });
  // 日期排序後重編堂次
  const arr=[...map.values()].sort((a,b)=>a.__displayDate.localeCompare(b.__displayDate));
  const group={};
  arr.forEach(it=>{
    const key=getCourseLabel(it)+"|"+(it["教師"]||"");
    (group[key]=group[key]||[]).push(it);
  });
  Object.values(group).forEach(g=>g.forEach((it,i)=>{it.__idx=i+1;it.__total=g.length}));
  return arr;
}

/* ---------- 畫面 ---------- */
let calendar;
const courseSel=document.getElementById("courseSelect");

fetch(apiUrl)
.then(r=>r.json())
.then(raw=>{
  const data=mergeRows(raw);
  initSelect(data);
  render(data);
  courseSel.onchange=()=>render(courseSel.value?data.filter(d=>getCourseLabel(d)===courseSel.value):data);
})
.catch(e=>alert("讀取資料失敗："+e));

function initSelect(list){
  const set=[...new Set(list.map(getCourseLabel))].sort();
  set.forEach(c=>{
    const o=document.createElement("option");
    o.value=o.textContent=c;courseSel.appendChild(o);
  });
}

function render(list){
  renderCal(list);
  renderTable(list);
}

function renderCal(list){
  const ev=list.map(r=>{
    const sT=fixTime(r["異動起始時間"]||r["起始時間"]);
    const eT=fixTime(r["異動結束時間"]||r["結束時間"]);
    const title=`${getCourseLabel(r)}\n${sT} - ${eT}${r["教師"]?" "+r["教師"]:""}${r["異動教室"]||r["教室"]?`\n${r["異動教室"]||r["教室"]}`:""}`;
    return{
      title,
      start:`${r.__displayDate}T${sT}`,
      end:`${r.__displayDate}T${eT}`,
      extendedProps:r
    };
  });

  if(calendar)calendar.destroy();
  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
    initialView:"dayGridMonth",
    locale:"zh-tw",
    headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},
    slotMinTime:"07:00:00",slotMaxTime:"20:00:00",
    events:ev,
    eventDidMount(info){
      const ext=info.event.extendedProps||{};
      info.el.style.background=ext.__isModified?"#FFDEB0":""; // 異動後的格子稍微底色
      // 加紅字
      if(ext.__isModified){
        info.el.querySelector(".fc-event-title").innerHTML=
          info.el.querySelector(".fc-event-title").innerHTML
            .replace(ext.startTime,`<span class="highlight-red">${ext.startTime}</span>`)
            .replace(ext.endTime,`<span class="highlight-red">${ext.endTime}</span>`)
            .replace(ext["異動教室"]||"",`<span class="highlight-red">${ext["異動教室"]||""}</span>`);
      }
    }
  });
  calendar.render();
}

function renderTable(list){
  document.getElementById("list-content").innerHTML=`<table>${[
    `<tr><th>狀態</th><th>日期</th><th>時間</th><th>課程</th><th>教師</th><th>教室</th><th>堂次</th><th>備註</th></tr>`,
    ...list.map(r=>{
      const sT=fixTime(r["異動起始時間"]||r["起始時間"]);
      const eT=fixTime(r["異動結束時間"]||r["結束時間"]);
      const cls=r.__isModified?"highlight-red":"";
      return `<tr class="${r.__isModified?"":"disabled-row"}">
        <td>🟡</td>
        <td>${r.__displayDate}${r.__isModified?"<span style='background:#555;color:#fff;border-radius:8px;padding:0 6px;margin-left:4px;font-size:.8em'>異動</span>":""}</td>
        <td class="${cls}">${sT} - ${eT}</td>
        <td>${getCourseLabel(r)}</td>
        <td>${r["教師"]||""}</td>
        <td class="${cls}">${r["異動教室"]||r["教室"]||""}</td>
        <td>${r.__idx}/${r.__total}</td>
        <td>${r["備註"]||""}</td>
      </tr>`;
    })
  ].join("")}</table>`;
}
</script>
</body>
</html>

