<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>113-2 é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 1em; }
    #filter-bar { max-width: 1100px; margin: auto; margin-bottom: 1em; display: flex; align-items: center; }
    #calendar { max-width: 1100px; margin: auto; }
    .fc-event.critical { background-color: #ffdddd !important; }
    .fc-event.changed { border: 2px solid red !important; }
    #courseSelect { margin-left: 0.5em; padding: 0.2em; font-size: 1em; }
  </style>
</head>
<body>
  <h2>ğŸ“… 113-2 èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</h2>
  <div id="filter-bar">
    <label for="courseSelect">ç¯©é¸èª²ç¨‹ï¼š</label>
    <select id="courseSelect"><option value="">å…¨éƒ¨</option></select>
  </div>
  <div id="calendar"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

// æ–°å¢ï¼šæ’åºå·¥å…·ï¼ˆå¹´ç´šï¼ç§‘ç›®ï¼æ™‚é–“ï¼‰
function courseSortKey(courseName) {
  // ç¯„ä¾‹: "ä¸‰ä¸Š æ•¸å­¸A"
  // å–å‡º"ä¸‰ä¸Š"æ’åºç”¨
  const match = courseName.match(/^([ä¸€äºŒä¸‰])[ä¸Šä¸‹]/);
  let n = 0;
  if (match) {
    if (match[1] === 'ä¸€') n = 1;
    if (match[1] === 'äºŒ') n = 2;
    if (match[1] === 'ä¸‰') n = 3;
  }
  return n + courseName;
}

let allData = [];
let calendar = null;

document.addEventListener('DOMContentLoaded', async function () {
  const res = await fetch(apiUrl);
  const data = await res.json();
  allData = data;

  // å–æ‰€æœ‰èª²ç¨‹åç¨±ï¼Œæ’åºå¾Œåšä¸‹æ‹‰
  const courses = [...new Set(data.map(item => getCourseLabel(item)))].sort((a, b) => {
    return courseSortKey(a) > courseSortKey(b) ? 1 : -1;
  });
  const select = document.getElementById('courseSelect');
  courses.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });

  renderCalendar(data);

  // ä¸‹æ‹‰é¸å–®åˆ‡æ›æ™‚ï¼Œé‡æ–°æ¸²æŸ“
  select.addEventListener('change', function () {
    const value = this.value;
    if (!value) {
      renderCalendar(allData);
    } else {
      renderCalendar(allData.filter(item => getCourseLabel(item) === value));
    }
  });
});

function getCourseLabel(item) {
  // æœ€æ¸…æ¥šçš„æ ¼å¼ï¼Œå…ˆé¡¯ç¤ºå¹´ç´šç§‘ç›®å†é™„åŠ ç­ç´šï¼ˆå¦‚é©ç”¨ï¼‰
  return item["èª²ç¨‹åç¨±"].replace(/\s+/g, ' ').trim();
}

function renderCalendar(data) {
  const events = data.map(item => {
    let date = item["æ—¥æœŸ"];
    if (typeof date === "string" && date.includes("T")) date = date.split("T")[0];
    date = date.replace(/\//g, "-");
    let [yyyy, mm, dd] = date.split("-");
    if (mm && mm.length === 1) mm = "0" + mm;
    if (dd && dd.length === 1) dd = "0" + dd;
    const dateFixed = `${yyyy}-${mm}-${dd}`;
    // æ”¹ï¼šèª²ç¨‹åç¨±å„ªå…ˆï¼ˆæ–°ç‰ˆtitleçµ„æˆï¼‰
    const startTime = item["èµ·å§‹æ™‚é–“"]?.slice(0,5);
    const endTime = item["çµæŸæ™‚é–“"]?.slice(0,5);
    const course = getCourseLabel(item);
    // titleå„ªå…ˆé¡¯ç¤ºèª²ç¨‹åç¨±ã€æ•™å¸«ã€æ™‚é–“
    const title = `${course}\n${startTime}-${endTime} ${item["æ•™å¸«"]||""}`;
    return {
      title: title,
      start: `${dateFixed}T${item["èµ·å§‹æ™‚é–“"]}`,
      end: `${dateFixed}T${item["çµæŸæ™‚é–“"]}`,
      backgroundColor: getColorByName(item["èª²ç¨‹åç¨±"]),
      classNames: getClass(item),
      extendedProps: item
    };
  });

  // éŠ·æ¯€å‰ä¸€å€‹ calendar
  if (calendar) calendar.destroy();

  calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'timeGridWeek', // å‘¨è¦–åœ–ï¼ˆé è¨­å‘¨è¡¨ï¼Œé¿å…é‡ç–Šï¼‰
    locale: 'zh-tw',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    // æ–°åŠŸèƒ½2ï¼šé€±è¡¨é¡¯ç¤ºä»¥ row å †ç–Šï¼ˆä¸é‡ç–Šï¼‰
    slotMinTime: "07:00:00",
    slotMaxTime: "20:00:00",
    allDaySlot: false,
    events,
    eventDidMount: function(info) {
      const p = info.event.extendedProps;
      const tooltip = 
        `èª²ç¨‹ï¼š${getCourseLabel(p)}\n` +
        `æ•™å¸«ï¼š${p["æ•™å¸«"]}\n` +
        `æ•™å®¤ï¼š${p["æ•™å®¤"]}\n` +
        `å ‚æ•¸ï¼š${p["ç•¶å‰å ‚æ•¸"]}/${p["ç¸½å ‚æ•¸"]}\n` +
        `å‚™è¨»ï¼š${p["å‚™è¨»"] || ""}`;
      info.el.title = tooltip;
      // titleå¤šè¡Œé¡¯ç¤º
      info.el.style.whiteSpace = "pre-line";
      info.el.style.fontSize = "1em";
    },
    // èª²ç¨‹æ’åºä¾ã€Œèª²ç¨‹åç¨±ã€åŠé–‹å§‹æ™‚é–“
    eventOrder: "title,start",
    eventMaxStack: 99,  // è®“äº‹ä»¶å…¨éƒ¨ä»¥rowæ–¹å¼å±•é–‹ï¼Œä¸é¡¯ç¤ºã€Œ+X moreã€
    nowIndicator: true,
    slotLabelFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },
    dayMaxEvents: false, // é—œé–‰æ—¥æ›†ã€Œ+X moreã€
    // å¼·åˆ¶ä¸é‡ç–Š
    eventOverlap: false
  });

  calendar.render();
}

function getColorByName(name) {
  const colors = ['#FFB6C1','#90EE90','#87CEFA','#FFD700','#FFA07A','#9370DB','#FF8C00','#20B2AA'];
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash += name.charCodeAt(i);
  return colors[hash % colors.length];
}

function getClass(item) {
  const result = [];
  if (Number(item["ç•¶å‰å ‚æ•¸"]) >= Math.ceil(Number(item["ç¸½å ‚æ•¸"]) / 3)) result.push("critical");
  return result;
}
</script>

</body>
</html>

