<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body{font-family:'Noto Sans TC','Microsoft JhengHei',Arial,sans-serif;margin:1em}
    h2{text-align:center;margin-bottom:.5em}
    #filter-bar{display:flex;justify-content:center;align-items:center;margin-bottom:1em;font-size:1.4em}
    #courseSelect{margin-left:.5em;padding:.4em 1em;font-size:1.1em}
    #calendar{max-width:1100px;margin:auto}
    /* å–æ¶ˆ FullCalendar é è¨­æ™‚é–“(ä¸‹åˆ5:10â€¦) */
    .fc-daygrid-event .fc-event-time{display:none!important}
    .fc-daygrid-event-dot{display:none}
    .fc-daygrid-event .fc-event-title,.fc-timegrid-event .fc-event-title{
      white-space:pre-line!important;font-weight:bold;font-size:1.06em;word-break:break-all}
    .course-icon{font-size:1.3em;margin-right:2px;vertical-align:middle}
    .highlight-red{color:#C00000!important;font-weight:bold!important}
    .disabled-bg{background:#888!important}
    .disabled-txt{color:#fff!important}
    .disabled-tag{border-radius:9px;padding:0 6px;background:#555;color:#fff;font-size:.8em;margin-left:6px}
    #list-container{max-width:1100px;margin:2em auto}
    #list-container table{border-collapse:collapse;width:100%}
    #list-container th,#list-container td{border:1px solid #aaa;padding:.5em;text-align:center;font-size:1.08em}
    #list-container th{background:#f4f4f4;font-size:1.13em}
    @media(max-width:800px){
      #calendar,#list-container{width:100%;font-size:.96em}
      #filter-bar{font-size:1.1em}}
  </style>
</head>
<body>
<h2>ğŸ“… 113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</h2>
<div id="filter-bar">ç¯©é¸èª²ç¨‹ï¼š
  <select id="courseSelect"><option value="">å…¨éƒ¨</option></select>
</div>
<div id="calendar"></div>
<div id="list-container">
  <h3>èª²ç¨‹åˆ—è¡¨ï¼ˆå«è·¨æœˆé¡¯ç¤ºï¼Œä¾æ—¥æœŸæ’åºï¼‰</h3>
  <div id="list-content"></div>
</div>

<script>
const apiUrl="https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

/* --------- åŸºç¤å·¥å…· --------- */
const COLUMNS_CHANGED=["ç•°å‹•æ—¥æœŸ","ç•°å‹•æ•™å®¤","ç•°å‹•èµ·å§‹æ™‚é–“","ç•°å‹•çµæŸæ™‚é–“"];

const fixDate=d=>{
  if(!d||d.startsWith("1899"))return"";
  if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(d)){let[s,m,da]=d.split("/");return`${s}-${m.padStart(2,"0")}-${da.padStart(2,"0")}`;}
  if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(d)){let[s,m,da]=d.split("-");return`${s}-${m.padStart(2,"0")}-${da.padStart(2,"0")}`;}
  return d;
};
const fixTime=t=>{
  if(!t)return"";
  let m=t.match(/(\d{1,2}):(\d{2})/);return m?`${m[1].padStart(2,"0")}:${m[2]}`:"";
};
const getCourseLabel=i=>i["èª²ç¨‹åç¨±"].replace(/\s+/g," ").trim();
const getColorByName= str=>{
  const colors=['#FFB6C1','#90EE90','#87CEFA','#FFD700','#FFA07A','#9370DB','#FF8C00',
                '#20B2AA','#E9967A','#48D1CC','#C71585','#B0E0E6','#FFB347','#B6FFB6','#B6B6FF'];
  let h=0;for(let c of str)h+=c.charCodeAt(0);return colors[h%colors.length];
};

/* --------- åˆä½µè¦å‰‡ ---------
   è‹¥ä»»ä¸€ç•°å‹•æ¬„ä½æœ‰å€¼ => ç”¢ç”Ÿå…©ç­†:
   (1) åŸå§‹è³‡æ–™ -> ç°åº•(__isDisabled)
   (2) ç•°å‹•å¾Œè³‡æ–™ -> __isModified = true
   å¦å‰‡åªç”¢ç”ŸåŸå§‹è³‡æ–™
--------------------------------*/
function mergeRows(rows){
  const out=[];
  const key=(c,t,d)=>`${c}|${t}|${d}`;
  const produced=new Set(); // é¿å…åŒ key ç°åº•é‡è¤‡

  rows.forEach(r=>{
    const course=getCourseLabel(r), teacher=r["æ•™å¸«"]||"", date0=fixDate(r["æ—¥æœŸ"]);
    const changed=COLUMNS_CHANGED.some(col=>r[col]);
    
    if(changed){
      /* ç°åº• (åŸç‹€) */
      const k0=key(course,teacher,date0);
      if(!produced.has(k0)){
        out.push({...r,__displayDate:date0,__isDisabled:true});
        produced.add(k0);
      }
      /* ç•°å‹•å¾Œ */
      const dateNew=fixDate(r["ç•°å‹•æ—¥æœŸ"])||date0;
      out.push({...r,__displayDate:dateNew,__isModified:true});
    }else{
      /* æ­£å¸¸ç„¡ç•°å‹• */
      out.push({...r,__displayDate:date0});
    }
  });

  /* ä¾æ—¥æœŸæ’åºä¸¦é‡æ–°è¨ˆç®—å ‚æ¬¡ */
  out.sort((a,b)=>a.__displayDate.localeCompare(b.__displayDate));
  const grp={};
  out.forEach(it=>{
    const k=getCourseLabel(it)+"|"+(it["æ•™å¸«"]||"");
    (grp[k]=grp[k]||[]).push(it);
  });
  Object.values(grp).forEach(g=>{
    let idx=1,total=g.filter(x=>!x.__isDisabled).length;
    g.forEach(it=>{if(!it.__isDisabled){it.__idx=idx++;it.__total=total;}});
  });
  return out;
}

/* ----------- ä¸»æµç¨‹ ----------- */
let calendar,allData;
document.addEventListener("DOMContentLoaded",async()=>{
  const res=await fetch(apiUrl);allData=await res.json();
  const merged=mergeRows(allData);

  /* ä¸‹æ‹‰é¸å–® */
  const sel=document.getElementById('courseSelect');
  [...new Set(merged.filter(x=>!x.__isDisabled).map(getCourseLabel))]
    .sort().forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;sel.appendChild(o);});
  
  const applyFilt=()=>{const v=sel.value||"";const f=v?merged.filter(x=>getCourseLabel(x)===v):merged;renderCalendar(f);renderList(f);}
  sel.addEventListener("change",applyFilt); applyFilt();
});

/* -------- FullCalendar -------- */
function renderCalendar(data){
  const ev=data.map(it=>{
    const st=fixTime(it["ç•°å‹•èµ·å§‹æ™‚é–“"]||it["èµ·å§‹æ™‚é–“"]),
          et=fixTime(it["ç•°å‹•çµæŸæ™‚é–“"]||it["çµæŸæ™‚é–“"]),
          room=it["ç•°å‹•æ•™å®¤"]||it["æ•™å®¤"]||"",
          title=`${getCourseLabel(it)}\n${st} - ${et}${it["æ•™å¸«"]?" "+it["æ•™å¸«"]:""}${room? "\n"+room:""}${it.__isDisabled?"\nã€å·²ç•°å‹•ã€‘":""}`;
    return{
      title,start:`${it.__displayDate}T${st}`,end:`${it.__displayDate}T${et}`,
      backgroundColor:it.__isDisabled?"#888":getColorByName(it["èª²ç¨‹åç¨±"]),
      textColor:it.__isDisabled?"#fff":"#222",
      extendedProps:{...it,startTime:st,endTime:et,room}
    };
  });

  if(calendar)calendar.destroy();
  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
    initialView:"dayGridMonth",locale:"zh-tw",displayEventTime:false, /* é—œæ‰é è¨­æ™‚é–“ */
    headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},
    events:ev,eventDidMount:info=>{
      /* ç‹€æ…‹ icon */
      const icon=document.createElement("span");icon.textContent="ğŸŸ¡";icon.className="course-icon";
      const t=info.el.querySelector(".fc-event-title");t&&t.prepend(icon);
      /* ç•°å‹•ç´…å­— */
      if(info.extendedProps.__isModified){
        ["ç•°å‹•æ•™å®¤","ç•°å‹•èµ·å§‹æ™‚é–“","ç•°å‹•çµæŸæ™‚é–“"].forEach(col=>{
          if(info.extendedProps[col]){
            t.innerHTML=t.innerHTML.replace(info.extendedProps[col],
              `<span class="highlight-red">${info.extendedProps[col]}</span>`);
          }
        });
      }
      if(info.extendedProps.__isDisabled)t.style.color="#fff";
    }
  });calendar.render();
}

/* ---------- åˆ—è¡¨ ---------- */
function renderList(data){
  const rows=data.map(it=>{
    const st=fixTime(it["ç•°å‹•èµ·å§‹æ™‚é–“"]||it["èµ·å§‹æ™‚é–“"]),
          et=fixTime(it["ç•°å‹•çµæŸæ™‚é–“"]||it["çµæŸæ™‚é–“"]),
          room=it["ç•°å‹•æ•™å®¤"]||it["æ•™å®¤"]||"",
          red=cls=>it[cls]?"highlight-red":"";
    return `<tr class="${it.__isDisabled?"disabled-bg":""}">
      <td style="font-size:1.3em;">ğŸŸ¡</td>
      <td class="${red("ç•°å‹•æ—¥æœŸ")} ${it.__isDisabled?"disabled-txt":""}">
        ${it.__displayDate}${it.__isDisabled?'<span class="disabled-tag">å·²ç•°å‹•</span>':""}</td>
      <td class="${it.__isDisabled?"disabled-txt":""}">
        <span class="${red("ç•°å‹•èµ·å§‹æ™‚é–“")}">${st}</span> -
        <span class="${red("ç•°å‹•çµæŸæ™‚é–“")}">${et}</span></td>
      <td class="${it.__isDisabled?"disabled-txt":""}">${getCourseLabel(it)}</td>
      <td class="${it.__isDisabled?"disabled-txt":""}">${it["æ•™å¸«"]||""}</td>
      <td class="${red("ç•°å‹•æ•™å®¤")} ${it.__isDisabled?"disabled-txt":""}">${room}</td>
      <td class="${it.__isDisabled?"disabled-txt":""}">${it.__idx?it.__idx+"/"+it.__total:""}</td>
      <td class="${it.__isDisabled?"disabled-txt":""}">${it["å‚™è¨»"]||""}</td>
    </tr>`;
  }).join("");
  document.getElementById("list-content").innerHTML=`
    <table><tr>
      <th>ç‹€æ…‹</th><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>èª²ç¨‹åç¨±</th><th>æ•™å¸«</th>
      <th>æ•™å®¤</th><th>å ‚æ¬¡</th><th>å‚™è¨»</th></tr>${rows}</table>`;
}
</script>
</body>
</html>
