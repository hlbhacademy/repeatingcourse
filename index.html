<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif; margin: 1em; }
    h2 { text-align: center; margin-bottom: 0.5em; }
    #filter-bar { display: flex; justify-content: center; align-items: center; margin-bottom: 1em; font-size: 1.4em;}
    #courseSelect { margin-left: 0.5em; padding: 0.4em 1em; font-size: 1.1em;}
    #calendar { max-width: 1100px; margin: auto; }
    .fc-daygrid-event-dot { display: none; }
    .fc-daygrid-event .fc-event-title, .fc-timegrid-event .fc-event-title {
      white-space: pre-line !important;
      font-weight: bold;
      font-size: 1.06em;
      word-break: break-all;
    }
    .fc-timegrid-event, .fc-timegrid-event .fc-event-title {
      color: #222 !important;
      min-height: 50px !important;
      height: auto !important;
      white-space: pre-line !important;
      overflow: visible !important;
    }
    .course-icon {
      font-size: 1.3em;
      margin-right: 2px;
      vertical-align: middle;
    }
    .highlight-red { color: #C00000 !important; font-weight: bold !important;}
    #list-container { max-width: 1100px; margin: 2em auto; }
    #list-container table { border-collapse: collapse; width: 100%; }
    #list-container th, #list-container td {
      border: 1px solid #aaa; padding: 0.5em; text-align: center; font-size: 1.08em;
    }
    #list-container th { background: #f4f4f4; font-size: 1.13em;}
    @media (max-width: 800px) {
      #calendar, #list-container { width: 100%; font-size: 0.96em;}
      #filter-bar { font-size: 1.1em;}
    }
    .fc-event, .fc-event-title, .fc-timegrid-event .fc-event-title, .fc-daygrid-event .fc-event-title { color: #222 !important; }
  </style>
</head>
<body>
  <h2>ğŸ“… 113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</h2>
  <div id="filter-bar">
    <label for="courseSelect">ç¯©é¸èª²ç¨‹ï¼š</label>
    <select id="courseSelect"><option value="">å…¨éƒ¨</option></select>
  </div>
  <div id="calendar"></div>
  <div id="list-container">
    <h3>èª²ç¨‹åˆ—è¡¨ï¼ˆå«è·¨æœˆé¡¯ç¤ºï¼Œä¾æ—¥æœŸæ’åºï¼‰</h3>
    <div id="list-content"></div>
  </div>
<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

// æ¨™æº–åŒ–æ ¼å¼
function fixDate(dateStr) {
  if (!dateStr) return "";
  if (dateStr.startsWith("1899") || dateStr.startsWith("Invalid")) return "";
  if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
    const [y, m, d] = dateStr.split("/");
    return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
  }
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
    const [y, m, d] = dateStr.split("-");
    return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
  }
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
  return dateStr;
}
function fixTime(t) {
  if (!t) return "";
  let m = t.match(/^(\d{1,2}):(\d{2})/);
  if (m) {
    let h = m[1].padStart(2,"0");
    return `${h}:${m[2]}`;
  }
  if (t.startsWith("1899") || t.startsWith("Invalid")) return "";
  return t;
}
function courseSortKey(courseName) {
  const match = courseName.match(/^([ä¸€äºŒä¸‰])[ä¸Šä¸‹]/);
  let n = 0;
  if (match) n = {ä¸€:1,äºŒ:2,ä¸‰:3}[match[1]];
  return n + courseName;
}
function getCourseLabel(item) {
  return item["èª²ç¨‹åç¨±"].replace(/\s+/g, ' ').trim();
}
function getColorByName(name) {
  const colors = [
    '#FFB6C1','#90EE90','#87CEFA','#FFD700','#FFA07A',
    '#9370DB','#FF8C00','#20B2AA','#E9967A','#48D1CC',
    '#C71585','#B0E0E6','#FFB347','#B6FFB6','#B6B6FF'
  ];
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash += name.charCodeAt(i);
  return colors[hash % colors.length];
}
function getCourseStatus(courseName, eventDate, allData) {
  const allEvents = allData.filter(x => getCourseLabel(x) === courseName)
    .sort((a, b) => new Date(a["æ—¥æœŸ"]) - new Date(b["æ—¥æœŸ"]));
  const total = parseInt(allEvents[0]["ç¸½å ‚æ•¸"] || allEvents.length);
  const today = new Date();
  const eventDay = new Date(eventDate);
  const lastDay = new Date(allEvents[allEvents.length - 1]["æ—¥æœŸ"]);
  const finishedCount = allEvents.filter(e => new Date(e["æ—¥æœŸ"]) < today).length;
  if (today > lastDay) {
    return { icon: "ğŸ”´", color: "#e74c3c", label: "å·²çµæŸ" };
  }
  if (finishedCount < total / 3) {
    return { icon: "ğŸŸ¢", color: "#27ae60", label: "å‰›é–‹å§‹" };
  } else {
    return { icon: "ğŸŸ¡", color: "#f7b731", label: "é€²è¡Œä¸­å·²é”1/3" };
  }
}

// æ±ºå®šè©²ç­†æ˜¯å¦ç‚ºç•°å‹•ç­†ï¼šåªæœ‰ç•°å‹•æ—¥æœŸæ‰æ˜¯æ–°äº‹ä»¶ï¼Œå…¶ä»–ç•°å‹•åªå¼·èª¿æ¬„ä½ä¸ç§»å‹•ä¸»éµ
function isRealChangedRow(item) {
  return item["ç•°å‹•æ—¥æœŸ"];
}

// å°‡æ‰€æœ‰åŸå§‹è³‡æ–™åˆæˆï¼ˆåƒ…æœ‰ç•°å‹•æ—¥æœŸæ‰ç§»é™¤åŸäº‹ä»¶ï¼Œå…¶ä»–ç•°å‹•åƒ…å¼·èª¿é¡è‰²ï¼‰
function getMergedData(data) {
  // å…ˆå»ºç«‹ key
  // key = èª²ç¨‹åç¨± + æ•™å¸« + åŸæ—¥æœŸ or ç•°å‹•æ—¥æœŸ
  const dataMap = {};
  data.forEach(item => {
    // å„ªå…ˆç•°å‹•æ—¥æœŸï¼Œå¦å‰‡ç”¨åŸæ—¥æœŸ
    const date = fixDate(item["ç•°å‹•æ—¥æœŸ"] || item["æ—¥æœŸ"]);
    const key = [
      getCourseLabel(item),
      item["æ•™å¸«"]||"",
      date
    ].join("|");
    // åªå­˜æœ€æ–°ç•°å‹•çš„è³‡æ–™ï¼Œå¦å‰‡åŸå§‹
    // è‹¥è©²æ—¥æœŸæœ‰ç•°å‹•è³‡æ–™ï¼Œå°±å­˜ç•°å‹•
    if (item["ç•°å‹•æ—¥æœŸ"]) {
      dataMap[key] = {
        ...item,
        __isDateChanged: true // æ¨™è¨»æ­¤ç­†ç•°å‹•æ—¥æœŸ
      };
    } else if (!dataMap[key]) {
      dataMap[key] = {
        ...item,
        __isDateChanged: false
      };
    }
  });
  // éæ¿¾æ‰æ‰€æœ‰ç•°å‹•æ—¥æœŸä¾†æºçš„èˆŠè³‡æ–™
  // è‹¥æœ‰ä¸€ç­†ç•°å‹•æ—¥æœŸç‚ºXï¼Œå‰‡åŒèª²ç¨‹+æ•™å¸«+åŸæœ¬æ—¥æœŸé‚£ç­†è¦æ’é™¤
  const excludedKeys = new Set();
  data.forEach(item => {
    if (item["ç•°å‹•æ—¥æœŸ"]) {
      const oriKey = [
        getCourseLabel(item),
        item["æ•™å¸«"]||"",
        fixDate(item["æ—¥æœŸ"])
      ].join("|");
      excludedKeys.add(oriKey);
    }
  });
  // ç”¢ç”Ÿæœ€çµ‚é¡¯ç¤ºæ¸…å–®
  return Object.entries(dataMap)
    .filter(([key, row]) => !excludedKeys.has(key) || row.__isDateChanged)
    .map(([key, row]) => row);
}

let allData = [];
let calendar = null;

document.addEventListener('DOMContentLoaded', async function () {
  const res = await fetch(apiUrl);
  const data = await res.json();
  allData = data;

  // çœŸæ­£åˆä½µå¾Œåªä¿ç•™è¦é¡¯ç¤ºçš„è³‡æ–™
  const mergedData = getMergedData(data);

  const courses = [...new Set(mergedData.map(item => getCourseLabel(item)))].sort((a, b) => {
    return courseSortKey(a) > courseSortKey(b) ? 1 : -1;
  });
  const select = document.getElementById('courseSelect');
  courses.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });

  renderCalendar(mergedData);
  renderList(mergedData);

  select.addEventListener('change', function () {
    const value = this.value;
    const filtered = (!value) ? mergedData : mergedData.filter(item => getCourseLabel(item) === value);
    renderCalendar(filtered);
    renderList(filtered);
  });
});

// åªè¦ç•°å‹•è©²æ¬„ä½æ‰ç´…å­—å¼·èª¿
function fieldClass(item, field) {
  if (field === 'æ—¥æœŸ')    return item["ç•°å‹•æ—¥æœŸ"]    ? "highlight-red" : "";
  if (field === 'èµ·å§‹æ™‚é–“')return item["ç•°å‹•èµ·å§‹æ™‚é–“"]? "highlight-red" : "";
  if (field === 'çµæŸæ™‚é–“') return item["ç•°å‹•çµæŸæ™‚é–“"] ? "highlight-red" : "";
  if (field === 'æ•™å®¤')    return item["ç•°å‹•æ•™å®¤"]    ? "highlight-red" : "";
  return "";
}
function getClass(item) {
  const result = [];
  if (Number(item["ç•¶å‰å ‚æ•¸"]) >= Math.ceil(Number(item["ç¸½å ‚æ•¸"]) / 3)) result.push("critical");
  return result;
}
function renderCalendar(data) {
  const events = data.map(item => {
    const date = fixDate(item["ç•°å‹•æ—¥æœŸ"] || item["æ—¥æœŸ"]);
    const startTime = fixTime(item["ç•°å‹•èµ·å§‹æ™‚é–“"] || item["èµ·å§‹æ™‚é–“"]);
    const endTime = fixTime(item["ç•°å‹•çµæŸæ™‚é–“"] || item["çµæŸæ™‚é–“"]);
    const course = getCourseLabel(item);
    const status = getCourseStatus(course, date, allData);
    const bgColor = getColorByName(item["èª²ç¨‹åç¨±"]);
    const classroom = item["ç•°å‹•æ•™å®¤"] || item["æ•™å®¤"] || "";
    // å¼·èª¿è©²ç•°å‹•æ¬„ç´…å­—
    let courseDisplay = `<span>${course}</span>`;
    let classroomDisplay = `<span class="${fieldClass(item, "æ•™å®¤")}">${classroom}</span>`;
    let dateDisplay = `<span class="${fieldClass(item, "æ—¥æœŸ")}">${date}</span>`;
    let timeDisplay = `<span class="${fieldClass(item, "èµ·å§‹æ™‚é–“")}">${startTime}</span>-<span class="${fieldClass(item, "çµæŸæ™‚é–“")}">${endTime}</span>`;
    // æ—¥æ›†äº‹ä»¶å…§å®¹
    const title = `${course}\n${startTime}-${endTime}${item["æ•™å¸«"] ? " " + item["æ•™å¸«"] : ""}${classroom ? "\n" + classroom : ""}`;
    return {
      title: title,
      start: `${date}T${startTime}`,
      end: `${date}T${endTime}`,
      classNames: [].concat(getClass(item)),
      extendedProps: { ...item, bg: bgColor, statusIcon: status.icon, statusLabel: status.label, course, classroom, startTime, endTime }
    };
  });
  if (calendar) calendar.destroy();
  calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'dayGridMonth',
    locale: 'zh-tw',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    slotMinTime: '07:00:00',
    slotMaxTime: '20:00:00',
    events,
    eventOrder: "title,start",
    dayMaxEvents: false,
    nowIndicator: true,
    eventOverlap: false,
    slotEventOverlap: false,
    eventMaxStack: 99,
    eventDidMount: function(info) {
      let iconNode = document.createElement("span");
      iconNode.className = "course-icon";
      iconNode.innerText = info.event.extendedProps.statusIcon;
      let titleNode = info.el.querySelector(".fc-event-title");
      if (titleNode && !titleNode.querySelector('.course-icon')) {
        titleNode.prepend(iconNode);
      }
      info.el.style.backgroundColor = info.event.extendedProps.bg;
      info.el.style.color = "#222";
      info.el.style.fontWeight = "bold";
      info.el.style.borderRadius = "7px";
      info.el.style.border = "none";
      info.el.title = info.event.extendedProps.statusLabel;
      info.el.style.height = "auto";
      // é‡å°éœ€è¦ç´…å­—æ¬„ä½åŠ å¼·
      // èª²å
      if (info.event.extendedProps["ç•°å‹•æ—¥æœŸ"] || info.event.extendedProps["ç•°å‹•èµ·å§‹æ™‚é–“"] || info.event.extendedProps["ç•°å‹•çµæŸæ™‚é–“"] || info.event.extendedProps["ç•°å‹•æ•™å®¤"]) {
        if (titleNode) {
          let html = titleNode.innerHTML;
          if (info.event.extendedProps["ç•°å‹•æ•™å®¤"]) {
            html = html.replace(info.event.extendedProps["classroom"], `<span class="highlight-red">${info.event.extendedProps["classroom"]}</span>`);
          }
          if (info.event.extendedProps["ç•°å‹•æ—¥æœŸ"]) {
            html = html.replace(info.event.extendedProps["æ—¥æœŸ"], `<span class="highlight-red">${info.event.extendedProps["ç•°å‹•æ—¥æœŸ"]}</span>`);
          }
          if (info.event.extendedProps["ç•°å‹•èµ·å§‹æ™‚é–“"]) {
            html = html.replace(info.event.extendedProps["èµ·å§‹æ™‚é–“"], `<span class="highlight-red">${info.event.extendedProps["ç•°å‹•èµ·å§‹æ™‚é–“"]}</span>`);
          }
          if (info.event.extendedProps["ç•°å‹•çµæŸæ™‚é–“"]) {
            html = html.replace(info.event.extendedProps["çµæŸæ™‚é–“"], `<span class="highlight-red">${info.event.extendedProps["ç•°å‹•çµæŸæ™‚é–“"]}</span>`);
          }
          // é é˜²æ²’ä¿®æ­£åˆ°çš„é‚„æ˜¯ç”¨é è¨­è‰²
          titleNode.innerHTML = html;
        }
      }
      titleNode && (titleNode.style.whiteSpace = "pre-line");
    }
  });
  calendar.render();
}
function renderList(data) {
  const sorted = [...data].sort((a, b) => {
    let da = fixDate(a["ç•°å‹•æ—¥æœŸ"] || a["æ—¥æœŸ"]);
    let db = fixDate(b["ç•°å‹•æ—¥æœŸ"] || b["æ—¥æœŸ"]);
    return da > db ? 1 : da < db ? -1 : 0;
  });
  let html = `<table>
  <tr>
    <th>ç‹€æ…‹</th>
    <th>æ—¥æœŸ</th>
    <th>æ™‚é–“</th>
    <th>èª²ç¨‹åç¨±</th>
    <th>æ•™å¸«</th>
    <th>æ•™å®¤</th>
    <th>å ‚æ¬¡</th>
    <th>å‚™è¨»</th>
  </tr>`;
  for (let item of sorted) {
    const date = fixDate(item["ç•°å‹•æ—¥æœŸ"] || item["æ—¥æœŸ"]);
    const startTime = fixTime(item["ç•°å‹•èµ·å§‹æ™‚é–“"] || item["èµ·å§‹æ™‚é–“"]);
    const endTime = fixTime(item["ç•°å‹•çµæŸæ™‚é–“"] || item["çµæŸæ™‚é–“"]);
    const classroom = item["ç•°å‹•æ•™å®¤"] || item["æ•™å®¤"] || "";
    const course = getCourseLabel(item);
    const status = getCourseStatus(course, date, data);
    html += `<tr>
      <td style="font-size:1.3em;">${status.icon}</td>
      <td class="${fieldClass(item, "æ—¥æœŸ")}">${date}</td>
      <td>
        <span class="${fieldClass(item, "èµ·å§‹æ™‚é–“")}">${startTime}</span>
        -
        <span class="${fieldClass(item, "çµæŸæ™‚é–“")}">${endTime}</span>
      </td>
      <td>${course}</td>
      <td>${item["æ•™å¸«"]||""}</td>
      <td class="${fieldClass(item, "æ•™å®¤")}">${classroom}</td>
      <td>${item["ç•¶å‰å ‚æ•¸"]||""}/${item["ç¸½å ‚æ•¸"]||""}</td>
      <td>${item["å‚™è¨»"]||""}</td>
    </tr>`;
  }
  html += `</table>`;
  document.getElementById('list-content').innerHTML = html;
}
</script>
</body>
</html>
