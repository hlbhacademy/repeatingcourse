<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>113-2 é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif; margin: 1em; }
    h2 { text-align: center; margin-bottom: 0.5em; }
    #filter-bar {
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 1em;
      font-size: 1.4em;
    }
    #courseSelect {
      margin-left: 0.5em;
      padding: 0.4em 1em;
      font-size: 1.1em;
    }
    #calendar { max-width: 1100px; margin: auto; }
    /* æœˆæª¢è¦–äº‹ä»¶é¡¯ç¤ºå®Œæ•´èª²ç¨‹åç¨±ä¸çœç•¥ */
    .fc-daygrid-event-dot { display: none; }
    .fc-daygrid-event .fc-event-title {
      white-space: pre-line;
      font-weight: bold;
      font-size: 1.06em;
      color: #172766;
    }
    .fc-event.critical { background-color: #ffdddd !important; }
    .fc-event.changed { border: 2px solid red !important; }
    /* æ–‡å­—è¡¨æ ¼å€ */
    #list-container { max-width: 1100px; margin: 2em auto; }
    #list-container table { border-collapse: collapse; width: 100%; }
    #list-container th, #list-container td {
      border: 1px solid #aaa; padding: 0.5em; text-align: center;
      font-size: 1.08em;
    }
    #list-container th {
      background: #f4f4f4;
      font-size: 1.13em;
    }
    @media (max-width: 800px) {
      #calendar, #list-container { width: 100%; font-size: 0.96em;}
      #filter-bar { font-size: 1.1em;}
    }
  </style>
</head>
<body>
  <h2>ğŸ“… 113-2 é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</h2>
  <div id="filter-bar">
    <label for="courseSelect">ç¯©é¸èª²ç¨‹ï¼š</label>
    <select id="courseSelect"><option value="">å…¨éƒ¨</option></select>
  </div>
  <div id="calendar"></div>
  <div id="list-container">
    <h3>èª²ç¨‹åˆ—è¡¨ï¼ˆå«è·¨æœˆé¡¯ç¤ºï¼Œä¾æ—¥æœŸæ’åºï¼‰</h3>
    <div id="list-content"></div>
  </div>
<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

// æ’åºç”¨
function courseSortKey(courseName) {
  const match = courseName.match(/^([ä¸€äºŒä¸‰])[ä¸Šä¸‹]/);
  let n = 0;
  if (match) n = {ä¸€:1,äºŒ:2,ä¸‰:3}[match[1]];
  return n + courseName;
}

let allData = [];
let calendar = null;

document.addEventListener('DOMContentLoaded', async function () {
  const res = await fetch(apiUrl);
  const data = await res.json();
  allData = data;

  // å–æ‰€æœ‰èª²ç¨‹åç¨±ï¼Œæ’åºå¾Œåšä¸‹æ‹‰
  const courses = [...new Set(data.map(item => getCourseLabel(item)))].sort((a, b) => {
    return courseSortKey(a) > courseSortKey(b) ? 1 : -1;
  });
  const select = document.getElementById('courseSelect');
  courses.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });

  renderCalendar(data);
  renderList(data);

  select.addEventListener('change', function () {
    const value = this.value;
    const filtered = (!value) ? allData : allData.filter(item => getCourseLabel(item) === value);
    renderCalendar(filtered);
    renderList(filtered);
  });
});

function getCourseLabel(item) {
  return item["èª²ç¨‹åç¨±"].replace(/\s+/g, ' ').trim();
}

function renderCalendar(data) {
  const events = data.map(item => {
    let date = item["æ—¥æœŸ"];
    if (typeof date === "string" && date.includes("T")) date = date.split("T")[0];
    date = date.replace(/\//g, "-");
    let [yyyy, mm, dd] = date.split("-");
    if (mm && mm.length === 1) mm = "0" + mm;
    if (dd && dd.length === 1) dd = "0" + dd;
    const dateFixed = `${yyyy}-${mm}-${dd}`;
    const startTime = item["èµ·å§‹æ™‚é–“"]?.slice(0,5);
    const endTime = item["çµæŸæ™‚é–“"]?.slice(0,5);
    const course = getCourseLabel(item);
    const color = getColorByName(item["èª²ç¨‹åç¨±"]);
    const title = `${course}\n${startTime}-${endTime}${item["æ•™å¸«"] ? " " + item["æ•™å¸«"] : ""}`;
    return {
      title: title,
      start: `${dateFixed}T${item["èµ·å§‹æ™‚é–“"]}`,
      end: `${dateFixed}T${item["çµæŸæ™‚é–“"]}`,
      color: color,
      textColor: "#222",
      classNames: getClass(item),
      extendedProps: { ...item, bg: color }
    };
  });

  if (calendar) calendar.destroy();

  calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'dayGridMonth',
    locale: 'zh-tw',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events,
    eventOrder: "title,start",
    dayMaxEvents: false,
    nowIndicator: true,
    eventOverlap: false,
    eventDidMount: function(info) {
      // ç„¡è«–å“ªä¸€ç¨®æª¢è¦–éƒ½ç”¨ inline style è¦†è“‹
      const color = info.event.extendedProps.bg;
      // æœˆæª¢è¦–
      if (info.el.classList.contains("fc-daygrid-event")) {
        info.el.style.backgroundColor = color;
        info.el.style.color = "#222";
        info.el.style.borderRadius = "7px";
        info.el.style.border = "none";
      }
      // é€±æª¢è¦–æˆ– list æª¢è¦–
      if (info.el.classList.contains("fc-timegrid-event") || info.el.classList.contains("fc-list-event")) {
        info.el.style.backgroundColor = color;
        info.el.style.color = "#222";
        info.el.style.borderRadius = "7px";
        info.el.style.border = "none";
      }
      info.el.title = ""; // ç§»é™¤åŸç”Ÿ tooltip
    }
  });

  calendar.render();
}

  if (calendar) calendar.destroy();

  calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'dayGridMonth', // é è¨­æœˆè¦–åœ–
    locale: 'zh-tw',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events,
    eventDidMount: function(info) {
      info.el.title = ""; // ä¸ç”¨ç€è¦½å™¨åŸç”Ÿ tooltip
    },
    eventOrder: "title,start",
    dayMaxEvents: false, // ä¸é¡¯ç¤º+X more
    nowIndicator: true,
    eventOverlap: false,
  });

  calendar.render();
}

// æ–°å¢ï¼šåŒæ­¥è¡¨æ ¼æ–‡å­—åˆ—å°æ‰€æœ‰èª²ç¨‹
function renderList(data) {
  // æ—¥æœŸå…ˆæ’åº
  const sorted = [...data].sort((a, b) => {
    let da = a["æ—¥æœŸ"], db = b["æ—¥æœŸ"];
    if (typeof da === "string" && da.includes("T")) da = da.split("T")[0];
    if (typeof db === "string" && db.includes("T")) db = db.split("T")[0];
    da = da.replace(/\//g, "-");
    db = db.replace(/\//g, "-");
    return da > db ? 1 : da < db ? -1 : 0;
  });
  let html = `<table>
  <tr>
    <th>æ—¥æœŸ</th>
    <th>æ™‚é–“</th>
    <th>èª²ç¨‹åç¨±</th>
    <th>æ•™å¸«</th>
    <th>æ•™å®¤</th>
    <th>å ‚æ¬¡</th>
    <th>å‚™è¨»</th>
  </tr>`;
  for (let item of sorted) {
    let date = item["æ—¥æœŸ"];
    if (typeof date === "string" && date.includes("T")) date = date.split("T")[0];
    date = date.replace(/\//g, "-");
    const startTime = item["èµ·å§‹æ™‚é–“"]?.slice(0,5);
    const endTime = item["çµæŸæ™‚é–“"]?.slice(0,5);
    html += `<tr>
      <td>${date}</td>
      <td>${startTime}-${endTime}</td>
      <td style="font-weight:bold;color:#336;">${getCourseLabel(item)}</td>
      <td>${item["æ•™å¸«"]||""}</td>
      <td>${item["æ•™å®¤"]||""}</td>
      <td>${item["ç•¶å‰å ‚æ•¸"]||""}/${item["ç¸½å ‚æ•¸"]||""}</td>
      <td>${item["å‚™è¨»"]||""}</td>
    </tr>`;
  }
  html += `</table>`;
  document.getElementById('list-content').innerHTML = html;
}

function getColorByName(name) {
  const colors = ['#FFB6C1','#90EE90','#87CEFA','#FFD700','#FFA07A','#9370DB','#FF8C00','#20B2AA'];
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash += name.charCodeAt(i);
  return colors[hash % colors.length];
}
function getClass(item) {
  const result = [];
  if (Number(item["ç•¶å‰å ‚æ•¸"]) >= Math.ceil(Number(item["ç¸½å ‚æ•¸"]) / 3)) result.push("critical");
  return result;
}
</script>
</body>
</html>
