<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
body{font-family:'Noto Sans TC','Microsoft JhengHei',Arial,sans-serif;margin:1em}
h2{text-align:center;margin-bottom:.5em}
#filter-bar{display:flex;justify-content:center;align-items:center;margin-bottom:1em;font-size:1.4em}
#courseSelect{margin-left:.5em;padding:.4em 1em;font-size:1.1em}
#calendar{max-width:1100px;margin:auto}
.fc-daygrid-event-dot{display:none}
.fc-daygrid-event .fc-event-title,.fc-timegrid-event .fc-event-title{white-space:pre-line!important;font-weight:bold;font-size:1.06em;word-break:break-all}
.fc-timegrid-event,.fc-timegrid-event .fc-event-title{color:#222!important;min-height:50px!important;height:auto!important;white-space:pre-line!important;overflow:visible!important}
.course-icon{font-size:1.3em;margin-right:2px;vertical-align:middle}
.highlight-red{color:#C00000!important;font-weight:bold}
.disabled-row{background:#888!important;color:#fff!important}
.disabled-row td{background:#888!important;color:#fff!important}
#list-container{max-width:1100px;margin:2em auto}
#list-container table{border-collapse:collapse;width:100%}
#list-container th,#list-container td{border:1px solid #aaa;padding:.5em;text-align:center;font-size:1.08em}
#list-container th{background:#f4f4f4;font-size:1.13em}
@media(max-width:800px){
  #calendar,#list-container{width:100%;font-size:.96em}
  #filter-bar{font-size:1.1em}
}
</style>
</head>
<body>
<h2>ğŸ“… 113-2 åœ‹ç«‹èŠ±è“®é«˜å•†é‡è£œä¿®èª²ç¨‹æŸ¥è©¢æ—¥æ›†</h2>

<div id="filter-bar">
  <label for="courseSelect">ç¯©é¸èª²ç¨‹ï¼š</label>
  <select id="courseSelect"><option value="">å…¨éƒ¨</option></select>
</div>

<div id="calendar"></div>

<div id="list-container">
  <h3>èª²ç¨‹åˆ—è¡¨ï¼ˆå«è·¨æœˆé¡¯ç¤ºï¼Œä¾æ—¥æœŸæ’åºï¼‰</h3>
  <div id="list-content"></div>
</div>

<script>
const apiUrl="https://script.google.com/macros/s/AKfycbxbpuFcInB-xFFGSVJReKEbp2DE5k8mDs8aKx80o94_fICApzgZ7_RI-j2kbDikG0jo/exec";

/* ---------- é€šç”¨å·¥å…· ---------- */
const fixDate=d=>{
  if(!d)return"";
  d=d.toString().trim().replace(/\//g,"-");
  const m=d.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  return m?`${m[1]}-${m[2].padStart(2,"0")}-${m[3].padStart(2,"0")}`:"";
};

const fixTime=t=>{
  if(!t)return"00:00";
  t=t.toString().replace(/\s+/g,"");
  // ä¸­æ–‡ä¸Šåˆ/ä¸‹åˆ
  let m=t.match(/^(ä¸Šåˆ|ä¸‹åˆ)(\d{1,2}):(\d{2})/);
  if(m){
    let h=parseInt(m[2],10);
    if(m[1]==="ä¸‹åˆ"&&h!==12)h+=12;
    if(m[1]==="ä¸Šåˆ"&&h===12)h=0;
    return `${h.toString().padStart(2,"0")}:${m[3]}`;
  }
  // AM / PM
  m=t.match(/^(\d{1,2}):(\d{2})(AM|PM)$/i);
  if(m){
    let h=parseInt(m[1],10);
    if(m[3].toUpperCase()==="PM"&&h!==12)h+=12;
    if(m[3].toUpperCase()==="AM"&&h===12)h=0;
    return `${h.toString().padStart(2,"0")}:${m[2]}`;
  }
  // ç´” 24hr
  m=t.match(/^(\d{1,2}):(\d{2})/);
  return m?`${m[1].padStart(2,"0")}:${m[2]}`:"00:00";
};

const getCourseLabel=it=>it["èª²ç¨‹åç¨±"].replace(/\s+/g," ").trim();

/* ---------- æŠŠç•°å‹•å‰ç´€éŒ„å»æ‰ï¼Œåªç•™ç•°å‹•å¾Œ ---------- */
function mergeRows(rows){
  const map=new Map(); // key = èª²ç¨‹+æ•™å¸«+åŸæ—¥æœŸ
  rows.forEach(r=>{
    const oriKey=[getCourseLabel(r),r["æ•™å¸«"]||"",fixDate(r["æ—¥æœŸ"])].join("|");
    if(r["ç•°å‹•æ—¥æœŸ"]){          // æœ‰ç•°å‹• â†’ ç”¨ç•°å‹•å¾Œçš„è³‡æ–™è¦†è“‹
      const newKey=[getCourseLabel(r),r["æ•™å¸«"]||"",fixDate(r["ç•°å‹•æ—¥æœŸ"])].join("|");
      map.set(newKey,{...r,__displayDate:fixDate(r["ç•°å‹•æ—¥æœŸ"]),__isModified:true});
    }else if(!map.has(oriKey)){ // æ²’ç•°å‹• â†’ å¦‚å°šæœªè¢«è¦†è“‹æ‰æ”¾å…¥
      map.set(oriKey,{...r,__displayDate:fixDate(r["æ—¥æœŸ"]),__isModified:false});
    }
  });
  // æ—¥æœŸæ’åºå¾Œé‡ç·¨å ‚æ¬¡
  const arr=[...map.values()].sort((a,b)=>a.__displayDate.localeCompare(b.__displayDate));
  const group={};
  arr.forEach(it=>{
    const key=getCourseLabel(it)+"|"+(it["æ•™å¸«"]||"");
    (group[key]=group[key]||[]).push(it);
  });
  Object.values(group).forEach(g=>g.forEach((it,i)=>{it.__idx=i+1;it.__total=g.length}));
  return arr;
}

/* ---------- ç•«é¢ ---------- */
let calendar;
const courseSel=document.getElementById("courseSelect");

fetch(apiUrl)
.then(r=>r.json())
.then(raw=>{
  const data=mergeRows(raw);
  initSelect(data);
  render(data);
  courseSel.onchange=()=>render(courseSel.value?data.filter(d=>getCourseLabel(d)===courseSel.value):data);
})
.catch(e=>alert("è®€å–è³‡æ–™å¤±æ•—ï¼š"+e));

function initSelect(list){
  const set=[...new Set(list.map(getCourseLabel))].sort();
  set.forEach(c=>{
    const o=document.createElement("option");
    o.value=o.textContent=c;courseSel.appendChild(o);
  });
}

function render(list){
  renderCal(list);
  renderTable(list);
}

function renderCal(list){
  const ev=list.map(r=>{
    const sT=fixTime(r["ç•°å‹•èµ·å§‹æ™‚é–“"]||r["èµ·å§‹æ™‚é–“"]);
    const eT=fixTime(r["ç•°å‹•çµæŸæ™‚é–“"]||r["çµæŸæ™‚é–“"]);
    const title=`${getCourseLabel(r)}\n${sT} - ${eT}${r["æ•™å¸«"]?" "+r["æ•™å¸«"]:""}${r["ç•°å‹•æ•™å®¤"]||r["æ•™å®¤"]?`\n${r["ç•°å‹•æ•™å®¤"]||r["æ•™å®¤"]}`:""}`;
    return{
      title,
      start:`${r.__displayDate}T${sT}`,
      end:`${r.__displayDate}T${eT}`,
      extendedProps:r
    };
  });

  if(calendar)calendar.destroy();
  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
    initialView:"dayGridMonth",
    locale:"zh-tw",
    headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},
    slotMinTime:"07:00:00",slotMaxTime:"20:00:00",
    events:ev,
    eventDidMount(info){
      const ext=info.event.extendedProps||{};
      info.el.style.background=ext.__isModified?"#FFDEB0":""; // ç•°å‹•å¾Œçš„æ ¼å­ç¨å¾®åº•è‰²
      // åŠ ç´…å­—
      if(ext.__isModified){
        info.el.querySelector(".fc-event-title").innerHTML=
          info.el.querySelector(".fc-event-title").innerHTML
            .replace(ext.startTime,`<span class="highlight-red">${ext.startTime}</span>`)
            .replace(ext.endTime,`<span class="highlight-red">${ext.endTime}</span>`)
            .replace(ext["ç•°å‹•æ•™å®¤"]||"",`<span class="highlight-red">${ext["ç•°å‹•æ•™å®¤"]||""}</span>`);
      }
    }
  });
  calendar.render();
}

function renderTable(list){
  document.getElementById("list-content").innerHTML=`<table>${[
    `<tr><th>ç‹€æ…‹</th><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>èª²ç¨‹</th><th>æ•™å¸«</th><th>æ•™å®¤</th><th>å ‚æ¬¡</th><th>å‚™è¨»</th></tr>`,
    ...list.map(r=>{
      const sT=fixTime(r["ç•°å‹•èµ·å§‹æ™‚é–“"]||r["èµ·å§‹æ™‚é–“"]);
      const eT=fixTime(r["ç•°å‹•çµæŸæ™‚é–“"]||r["çµæŸæ™‚é–“"]);
      const cls=r.__isModified?"highlight-red":"";
      return `<tr class="${r.__isModified?"":"disabled-row"}">
        <td>ğŸŸ¡</td>
        <td>${r.__displayDate}${r.__isModified?"<span style='background:#555;color:#fff;border-radius:8px;padding:0 6px;margin-left:4px;font-size:.8em'>ç•°å‹•</span>":""}</td>
        <td class="${cls}">${sT} - ${eT}</td>
        <td>${getCourseLabel(r)}</td>
        <td>${r["æ•™å¸«"]||""}</td>
        <td class="${cls}">${r["ç•°å‹•æ•™å®¤"]||r["æ•™å®¤"]||""}</td>
        <td>${r.__idx}/${r.__total}</td>
        <td>${r["å‚™è¨»"]||""}</td>
      </tr>`;
    })
  ].join("")}</table>`;
}
</script>
</body>
</html>

